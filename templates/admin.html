{% extends "base.html" %}

{% block content %}
<style>
    /* تنسيقات خاصة */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
    .st-active { background: #dcfce7; color: #166534; }
    .st-expired { background: #fee2e2; color: #991b1b; }
    .st-stopped { background: #fef3c7; color: #92400e; }

    .btn-action { width: 35px; height: 35px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; color: white; margin-left: 5px; text-decoration: none; }
    
    /* مودال */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 10% auto; padding: 30px; border-radius: 16px; width: 400px; position: relative; }
    .plan-option { border: 2px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; }
    .plan-option.selected { border-color: #3b82f6; background: #eff6ff; }
</style>

<div class="page-header" style="margin-bottom: 25px;">
    <h1 style="margin: 0; font-size: 1.8rem;">لوحة القيادة (Admin)</h1>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background: #e0f2fe; color: #0284c7;"><i class="fas fa-store"></i></div>
        <div><h3 style="margin:0">{{ stats.total_shops }}</h3><p style="margin:0; color:#777">إجمالي المتاجر</p></div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #dcfce7; color: #16a34a;"><i class="fas fa-check-circle"></i></div>
        <div><h3 style="margin:0">{{ stats.active_shops }}</h3><p style="margin:0; color:#777">اشتراكات نشطة</p></div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #fae8ff; color: #9333ea;"><i class="fas fa-money-bill-wave"></i></div>
        <div><h3 style="margin:0">{{ stats.total_revenue }}</h3><p style="margin:0; color:#777">الإيرادات (د.ل)</p></div>
    </div>
</div>

<div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
    <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="بحث..." style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 300px;">
    
    <div style="display: flex; gap: 10px;">
        <a href="{{ url_for('manage_admins') }}" class="btn" style="background: #475569; color: white;"><i class="fas fa-user-shield"></i> المشرفين</a>
        <a href="{{ url_for('admin_export_pdf') }}" target="_blank" class="btn" style="background: #ef4444; color: white;">
            <i class="fas fa-file-pdf"></i> تقرير PDF
        </a>
    </div>
</div>

<div style="background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
    <table id="shopsTable" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <th style="padding: 15px; text-align: right;">المتجر</th>
                <th style="padding: 15px; text-align: right;">المالك</th>
                <th style="padding: 15px; text-align: right;">حالة الاشتراك</th>
                <th style="padding: 15px; text-align: center;">إجراءات</th>
            </tr>
        </thead>
        <tbody>
            {% for item in shops %}
            <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 15px;">
                    <div style="font-weight: bold;">{{ item.shop.name }}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">{{ item.shop.phone }}</div>
                </td>
                <td style="padding: 15px;">{{ item.owner_name }}</td>
                <td style="padding: 15px;">
                    {% if item.status == 'stopped' %}
                        <span class="status-badge st-stopped">متوقف</span>
                    {% elif item.status == 'active' %}
                        <span class="status-badge st-active">نشط ({{ item.days_left }} يوم)</span>
                    {% else %}
                        <span class="status-badge st-expired">منتهي</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    <button onclick="openRenewModal('{{ item.shop.id }}', '{{ item.shop.name }}')" class="btn-action" style="background: #3b82f6;" title="تجديد"><i class="fas fa-sync-alt"></i></button>
                    <a href="{{ url_for('toggle_shop_status', id=item.shop.id) }}" class="btn-action" style="background: {% if item.shop.is_active %}#f59e0b{% else %}#10b981{% endif %};"><i class="fas {% if item.shop.is_active %}fa-pause{% else %}fa-play{% endif %}"></i></a>
                    <a href="{{ url_for('admin_edit_shop', id=item.shop.id) }}" class="btn-action" style="background: #64748b;"><i class="fas fa-edit"></i></a>
                    <a href="{{ url_for('delete_shop', id=item.shop.id) }}" onclick="return confirm('حذف نهائي؟')" class="btn-action" style="background: #ef4444;"><i class="fas fa-trash-alt"></i></a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="renewModal" class="modal">
    <div class="modal-content">
        <span onclick="document.getElementById('renewModal').style.display='none'" style="position: absolute; left: 20px; top: 20px; cursor: pointer; font-size: 1.5rem;">&times;</span>
        <h3 style="margin-top: 0; margin-bottom: 20px;">تجديد اشتراك: <span id="modalShopName" style="color: #3b82f6;"></span></h3>
        <form action="{{ url_for('renew_subscription') }}" method="POST">
            <input type="hidden" name="shop_id" id="modalShopId">
            <input type="hidden" name="plan_name" id="selectedPlanName" value="1 Month">
            <input type="hidden" name="price" id="selectedPrice" value="150">
            <div class="plan-option selected" onclick="selectPlan(this, '1 Month', 150)">
                <div><b>باقة شهرية</b><br><small style="color:#666">30 يوم</small></div>
                <div style="color: #3b82f6; font-weight: bold;">150 د.ل</div>
            </div>
            <div class="plan-option" onclick="selectPlan(this, '6 Months', 800)">
                <div><b>نصف سنوية</b><br><small style="color:#666">180 يوم</small></div>
                <div style="color: #3b82f6; font-weight: bold;">800 د.ل</div>
            </div>
            <div class="plan-option" onclick="selectPlan(this, '1 Year', 1500)">
                <div><b>باقة سنوية</b><br><small style="color:#666">365 يوم</small></div>
                <div style="color: #3b82f6; font-weight: bold;">1500 د.ل</div>
            </div>
            <button type="submit" class="btn" style="width: 100%; margin-top: 20px; background: #10b981; color: white;">تأكيد التجديد</button>
        </form>
    </div>
</div>

<script>
    function searchTable() {
        var input = document.getElementById("searchInput");
        var filter = input.value.toUpperCase();
        var table = document.getElementById("shopsTable");
        var tr = table.getElementsByTagName("tr");
        for (var i = 0; i < tr.length; i++) {
            var tdName = tr[i].getElementsByTagName("td")[0];
            if (tdName) {
                var txtValue = tdName.textContent || tdName.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) { tr[i].style.display = ""; } 
                else { tr[i].style.display = "none"; }
            }       
        }
    }
    function openRenewModal(id, name) {
        document.getElementById("modalShopId").value = id;
        document.getElementById("modalShopName").innerText = name;
        document.getElementById("renewModal").style.display = "block";
    }
    function selectPlan(el, name, price) {
        document.querySelectorAll('.plan-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById("selectedPlanName").value = name;
        document.getElementById("selectedPrice").value = price;
    }
</script>
{% endblock %}