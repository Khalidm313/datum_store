{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    /* انسخ الستايل الموجود في ملفك الحالي هنا أو اترك الملف كما هو فقط عدل الأجزاء أدناه */
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');

    :root {
        --bg-app: #0f111a;
        --bg-panel: #1e212b;
        --border-color: #2d3242;
        --accent: #3b82f6;
        --text-main: #e2e8f0;
        --text-muted: #94a3b8;
    }

    .statement-container {
        font-family: 'Tajawal', sans-serif;
        padding: 30px;
        background-color: var(--bg-app);
        min-height: calc(100vh - 60px);
    }

    /* ... باقي الستايل ... */
    
    .toolbar {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; padding: 15px;
        background: var(--bg-panel); border: 1px solid var(--border-color);
        border-radius: 12px;
    }
    /* ... */
    .statement-paper {
        background: var(--bg-panel);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        max-width: 1000px; margin: 0 auto;
        color: var(--text-main);
    }
    
    /* ... */
    
    @media print {
        body * { visibility: hidden; }
        .statement-paper, .statement-paper * { visibility: visible; }
        .statement-paper {
            position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px;
            background: #fff !important; color: #000 !important;
            border: none; box-shadow: none;
        }
        .statement-table th { background: #f3f4f6 !important; color: #000 !important; border-bottom: 2px solid #000 !important; }
        .statement-table td { border-bottom: 1px solid #ddd !important; color: #000 !important; }
        .toolbar, .sidebar, header { display: none !important; }
        .balance-row { background: #eee !important; }
    }
</style>

<div class="statement-container">
    
    <div class="toolbar">
        <div class="page-title">
            <i class="fas fa-file-invoice-dollar"></i> كشف حساب عملة
        </div>
        <div class="action-group">
            <button onclick="printStatement()" class="btn-action btn-print" style="background: #3b82f6; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">
                <i class="fas fa-print"></i> طباعة الكشف
            </button>
            <button onclick="saveAsPDF()" class="btn-action btn-pdf" style="background: #ef4444; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">
                <i class="fas fa-file-pdf"></i> حفظ PDF
            </button>
        </div>
    </div>

    <div id="printArea" class="statement-paper">
        
        <div class="paper-header" style="border-bottom: 2px solid var(--border-color); padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between;">
            <div class="company-info">
                <h2 style="margin:0; color:#3b82f6;">{{ current_user.shop.name }}</h2>
                <div style="margin-top:5px; font-size:0.9rem; color:#94a3b8;">كشف حركة حساب / خزينة</div>
            </div>
            <div class="statement-meta" style="text-align:left; font-size:0.9rem; color:#94a3b8;">
                <div><strong>التاريخ:</strong> <span id="currentDate"></span></div>
                <div><strong>العملة:</strong> {{ current_user.shop.currency }}</div>
                <div><strong>المستخدم:</strong> {{ current_user.username }}</div>
            </div>
        </div>

        <table class="statement-table" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr>
                    <th style="padding:12px; text-align:right; border-bottom:1px solid #2d3242;">#</th>
                    <th style="padding:12px; text-align:right; border-bottom:1px solid #2d3242;">التاريخ</th>
                    <th style="padding:12px; text-align:right; border-bottom:1px solid #2d3242;">البيان / الوصف</th>
                    <th style="padding:12px; text-align:right; border-bottom:1px solid #2d3242;">وارد (مدين)</th>
                    <th style="padding:12px; text-align:right; border-bottom:1px solid #2d3242;">صادر (دائن)</th>
                    <th style="padding:12px; text-align:right; border-bottom:1px solid #2d3242;">الرصيد</th>
                </tr>
            </thead>
            <tbody>
                {% for trans in transactions %}
                <tr>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">{{ loop.index }}</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">{{ trans.date }}</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">{{ trans.description }}</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242; color:#10b981;">{{ trans.debit if trans.debit > 0 else '-' }}</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242; color:#ef4444;">{{ trans.credit if trans.credit > 0 else '-' }}</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">{{ trans.balance }}</td>
                </tr>
                {% else %}
                <tr>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">1</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">2025-01-01</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">رصيد افتتاحي</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242; color:#10b981;">10,000.00</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">-</td>
                    <td style="padding:12px; border-bottom:1px solid #2d3242;">10,000.00</td>
                </tr>
                {% endfor %}
                
                <tr class="balance-row" style="background: rgba(16, 185, 129, 0.1); font-weight: bold;">
                    <td colspan="3" style="padding:12px; text-align: left;">الرصيد النهائي:</td>
                    <td style="padding:12px; color:#10b981;">10,500.00</td>
                    <td style="padding:12px; color:#ef4444;">2,000.00</td>
                    <td style="padding:12px;">8,500.00</td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top: 40px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
            <div>توقيع المحاسب: ....................</div>
            <div>توقيع المدير: ....................</div>
        </div>
        <div style="text-align: center; margin-top: 20px; font-size: 0.7rem; color: #999;">
            تم استخراج هذا الكشف من نظام {{ current_user.shop.name }} بتاريخ <span id="printTime"></span>
        </div>
    </div>

</div>

<script>
    const now = new Date();
    document.getElementById('currentDate').innerText = now.toLocaleDateString('en-GB');
    document.getElementById('printTime').innerText = now.toLocaleString('en-GB');

    function printStatement() { window.print(); }

    function saveAsPDF() {
        const element = document.getElementById('printArea');
        const opt = {
            margin: 0.5,
            filename: 'Account_Statement.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        const originalBg = element.style.background;
        const originalColor = element.style.color;
        
        element.style.background = '#ffffff';
        element.style.color = '#000000';
        
        html2pdf().set(opt).from(element).save().then(() => {
            element.style.background = originalBg;
            element.style.color = originalColor;
        });
    }
</script>
{% endblock %}