{% extends "base.html" %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 380px; gap: 25px; height: calc(100vh - 60px);">
    
    <div class="card" style="margin: 0; display: flex; flex-direction: column; padding: 20px;">
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <input type="text" id="searchBox" class="form-control" placeholder="بحث باسم المنتج..." onkeyup="filterProducts()" style="flex: 2;">
            <input type="text" id="barcodeScanner" class="form-control" placeholder="الباركود..." autofocus style="flex: 1;">
        </div>

        <div id="productGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; overflow-y: auto; padding-right: 5px;">
            {% for p in products %}
            <div class="product-card" 
                 onclick="addToCart({{ p.id }}, '{{ p.name }}', {{ p.sell_price }}, {{ p.stock }})"
                 data-name="{{ p.name }}" 
                 data-barcode="{{ p.barcode }}"
                 style="background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; cursor: pointer; text-align: center; transition: 0.2s; position: relative;">
                
                <span style="position: absolute; top: 8px; left: 8px; font-size: 0.7rem; background: var(--bg-card); padding: 2px 6px; border-radius: 4px; color: var(--text-muted);">{{ p.stock }}</span>
                <div style="font-size: 2rem; color: var(--text-muted); margin-bottom: 10px;"><i class="fas fa-box"></i></div>
                <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ p.name }}</div>
                <div style="color: var(--primary); font-weight: 800;">{{ p.sell_price }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card" style="margin: 0; display: flex; flex-direction: column;">
        
        <div style="margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
            <label style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; display: block; font-weight: bold;">
                <i class="fas fa-user-circle"></i> بيانات العميل
            </label>
            
            <input list="clist" id="custName" class="form-control" placeholder="اسم العميل (بحث أو جديد)..." onchange="autoFillCustomer()" style="margin-bottom: 8px;">
            <datalist id="clist">
                {% for c in customers %}
                <option value="{{ c.name }}" data-phone="{{ c.phone }}" data-email="{{ c.email }}" data-id="{{ c.id }}">
                {% endfor %}
            </datalist>
            <input type="hidden" id="custId">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <input id="custPhone" class="form-control" placeholder="رقم الهاتف">
                <input id="custEmail" class="form-control" placeholder="البريد الإلكتروني">
            </div>
            <input id="custNotes" class="form-control" placeholder="ملاحظات العميل" style="margin-top: 8px;">
        </div>

        <div id="cartItems" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 15px; padding: 10px; background: var(--bg-body);">
            <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">السلة فارغة</div>
        </div>

        <div style="background: var(--primary-soft); border: 1px solid var(--primary); padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px;">
            <div style="font-size: 0.9rem; color: var(--primary);">المجموع الكلي</div>
            <div id="cartTotalFinal" style="font-size: 1.8rem; font-weight: 900; color: var(--text-main);">0.00</div>
        </div>

        <button class="btn" onclick="submitInvoice('paid')" style="width: 100%; background: var(--success); margin-bottom: 10px;">
            <i class="fas fa-check"></i> دفع فوري
        </button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn" onclick="submitInvoice('pending')" style="background: transparent; border: 1px solid var(--warning); color: var(--warning);">آجل (دين)</button>
            <button class="btn" onclick="clearCart()" style="background: transparent; border: 1px solid var(--danger); color: var(--danger);">إلغاء</button>
        </div>
    </div>
</div>

<script>
    let cart = [];
    
    function renderCart() {
        const container = document.getElementById('cartItems');
        container.innerHTML = '';
        let total = 0;
        if (cart.length === 0) {
            container.innerHTML = `<div style="text-align: center; color: var(--text-muted); margin-top: 50px;">السلة فارغة</div>`;
            document.getElementById('cartTotalFinal').innerText = '0.00';
            return;
        }
        cart.forEach((item, index) => {
            total += item.price * item.quantity;
            container.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 0.9rem;">${item.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${item.price}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; background: var(--bg-body); padding: 4px; border-radius: 6px;">
                        <button onclick="updateQty(${index}, -1)" style="background:none; border:none; color:var(--text-main); cursor:pointer;">-</button>
                        <span style="font-size: 0.9rem;">${item.quantity}</span>
                        <button onclick="updateQty(${index}, 1)" style="background:none; border:none; color:var(--text-main); cursor:pointer;">+</button>
                    </div>
                    <div style="font-weight: bold; color: var(--primary); margin-right: 10px;">
                        ${(item.price * item.quantity).toFixed(2)}
                    </div>
                </div>`;
        });
        document.getElementById('cartTotalFinal').innerText = total.toFixed(2);
    }

    function updateQty(i,c){ let it=cart[i]; if(c===1){if(it.quantity<it.max)it.quantity++;else alert('الكمية غير متوفرة');}else{if(it.quantity>1)it.quantity--;else cart.splice(i,1);} renderCart(); }
    function addToCart(id,n,p,m){ let idx=cart.findIndex(x=>x.id===id); if(idx!==-1)updateQty(idx,1); else{if(m>0){cart.push({id:id,name:n,price:p,quantity:1,max:m});renderCart();}else alert('نفذت الكمية');} }
    
    function clearCart(){ 
        cart=[]; renderCart(); 
        document.getElementById('custName').value=''; 
        document.getElementById('custPhone').value=''; 
        document.getElementById('custEmail').value=''; // تفريغ
        document.getElementById('custNotes').value=''; // تفريغ
        document.getElementById('custId').value=''; 
    }

    function filterProducts(){ let v=document.getElementById('searchBox').value.toLowerCase(); document.querySelectorAll('.product-card').forEach(c=>{ let n=c.dataset.name.toLowerCase(); let b=c.dataset.barcode||""; c.style.display=(n.includes(v)||b.includes(v))?'block':'none'; }); }
    
    document.getElementById('barcodeScanner').addEventListener('keypress',function(e){ 
        if(e.key==='Enter'){ 
            let b=this.value; this.value=''; 
            fetch(`/api/get_product_by_barcode/${b}`).then(r=>r.json()).then(d=>{ 
                if(d.success) addToCart(d.id,d.name,d.price,999); else alert('غير موجود'); 
            }); 
        } 
    });

    function autoFillCustomer(){ 
        let v=document.getElementById('custName').value; 
        let ops=document.getElementById('clist').options; 
        for(let i=0;i<ops.length;i++){ 
            if(ops[i].value===v){ 
                document.getElementById('custPhone').value = ops[i].getAttribute('data-phone') || "";
                document.getElementById('custEmail').value = ops[i].getAttribute('data-email') || ""; // ملء تلقائي
                document.getElementById('custId').value = ops[i].getAttribute('data-id'); 
                break; 
            } 
        } 
    }

    function submitInvoice(s){
        if(cart.length===0)return alert('السلة فارغة');
        
        // تجميع البيانات لإرسالها
        let payload = {
            items: cart,
            customer_id: document.getElementById('custId').value,
            customer_name: document.getElementById('custName').value,
            customer_phone: document.getElementById('custPhone').value,
            customer_email: document.getElementById('custEmail').value, // جديد
            customer_notes: document.getElementById('custNotes').value, // جديد
            status: s
        };

        fetch('/api/create_invoice', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r=>r.json())
        .then(res=>{ 
            if(res.success){ 
                if(confirm('تم الحفظ بنجاح! هل تريد طباعة الفاتورة؟')) window.open(`/invoice/print/${res.invoice_id}`,'_blank'); 
                clearCart(); 
            } else { 
                alert('خطأ: ' + res.message); 
            } 
        });
    }
</script>
{% endblock %}
